pipeline {
    agent any
    
    environment {
        GIT_REPO_URL = 'https://github.com/anirudhpratapsingh/jenkins-demo.git'
    }

    stages {
        stage('Checkout') {
           steps {
             script {
            def gitResult = git branch: 'main', credentialsId: '3c32a489-c641-428c-8162-bc463f5fb0f4', url: env.GIT_REPO_URL, returnStatus: true
            def gitExitCode = gitResult.GIT_BRANCH ? 0 : 1
            echo "Git checkout exit code: ${gitExitCode}"

            if (gitExitCode != 0) {
                error('Git checkout failed')
            }
        }
    }
}


        stage('Build') {
            steps {
                
                                      
                    sh 'composer install'

                
            }
        }

        stage('Test') {
            steps {
                
                     
                                
                    sh 'vendor/bin/phpunit --debug'
                
            }
        }

       stage('Deploy to EC2') {
           steps {
             script {
            
            def bastionHost = '107.20.38.66'
            def ec2Host = '10.0.2.115'
            def privateKey = credentials('bastion-host-key')

            sshagent(['bastion-host-key']) {
                sh "ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${ec2Host} 'rm -rf /var/www/deploy/*'"
            }
            sh "scp -i ${privateKey} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r target/* ubuntu@${bastionHost}:/tmp/"

            
            sshagent(['bastion-host-key']) {
    sh """
        ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${bastionHost} \
            ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${ec2Host} 'mkdir -p /var/www/deploy' \
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r /tmp/* ubuntu@${ec2Host}:/var/www/deploy
    """
}

        }
    }
}

    }
}
