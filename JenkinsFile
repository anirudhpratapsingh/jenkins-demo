pipeline {
    agent any
    
    environment {
        GIT_REPO_URL = 'https://github.com/anirudhpratapsingh/jenkins-demo.git'
    }

    stages {
        stage('Checkout') {
           steps {
             script {
            def gitResult = git branch: 'main', credentialsId: '3c32a489-c641-428c-8162-bc463f5fb0f4', url: env.GIT_REPO_URL, returnStatus: true
            def gitExitCode = gitResult.GIT_BRANCH ? 0 : 1
            echo "Git checkout exit code: ${gitExitCode}"

            if (gitExitCode != 0) {
                error('Git checkout failed')
            }
        }
    }
}


        stage('Build') {
            steps {
                
                                      
                    sh 'composer install'

                
            }
        }

        stage('Test') {
            steps {
                
                     
                                
                    sh 'vendor/bin/phpunit --debug'
                
            }
        }

       stage('Deploy to EC2') {
            steps {
              script {
            // Define variables
            def bastionHost = '107.20.38.66'
            def webServerHost = '10.0.2.115'
            def privateKey = credentials('bastion-host-key')

            // SSH into the bastion host and execute commands
            sshagent(['bastion-host-key']) {
                // Remove existing files on the web server
                sh "ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${bastionHost} 'ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${webServerHost} rm -rf /var/www/deploy/*'"

                // Copy files from Jenkins to bastion host
                sh "scp -i ${privateKey} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r /var/lib/jenkins/workspace/pipelineone/src/ ubuntu@${bastionHost}:/tmp/"

                // Copy files from bastion host to web server
                sh "ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${bastionHost} ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${webServerHost} 'mkdir -p /var/www/deploy && cp -r /tmp/* /var/www/deploy/'"
            }
        }
    }
}



    }
}
