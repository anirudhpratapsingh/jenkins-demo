pipeline {
    agent any
    
    environment {
        GIT_REPO_URL = 'https://github.com/anirudhpratapsingh/jenkins-demo.git'
    }

    stages {
        stage('Checkout') {
            steps {
                 
                    git branch: 'main', credentialsId: '3c32a489-c641-428c-8162-bc463f5fb0f4', url: env.GIT_REPO_URL
                
            }
        }
       

        stage('Build') {
            steps {
                
                                      
                    sh 'composer install'

                
            }
        }

        stage('Test') {
            steps {
                
                     
                                
                    sh 'vendor/bin/phpunit --debug'
                
            }
        }

       stage('Deploy to EC2') {
           steps {
             script {
            // Variables
            def bastionHost = '54.162.192.96'
            def ec2Host = '10.0.2.115'
            def privateKey = credentials('bastion-host-key')

            // Copy artifacts to the bastion host
            sh "scp -i ${privateKey} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r target/* ubuntu@${bastionHost}:/tmp/"

            // SSH into the bastion host and copy artifacts to the EC2 instance
            sshagent(['bastion-host-key']) {
                sh """
                    ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${bastionHost} << 'EOF'
                        ssh -A -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@${ec2Host} 'mkdir -p /var/www/deploy'
                        scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r /tmp/* ubuntu@${ec2Host}:/var/www/deploy
                    EOF
                """
            }
        }
    }
}

    }
}
