pipeline {
    agent any
    
    environment {
        GIT_REPO_URL = 'https://github.com/anirudhpratapsingh/jenkins-demo.git'
    }

    stages {
        stage('Checkout') {
           steps {
             script {
            def gitResult = git branch: 'main', credentialsId: '3c32a489-c641-428c-8162-bc463f5fb0f4', url: env.GIT_REPO_URL, returnStatus: true
            def gitExitCode = gitResult.GIT_BRANCH ? 0 : 1
            echo "Git checkout exit code: ${gitExitCode}"

            if (gitExitCode != 0) {
                error('Git checkout failed')
            }
        }
    }
}


        stage('Build') {
            steps {
                
                                      
                    sh 'composer install'

                
            }
        }

        stage('Test') {
            steps {
                
                     
                                
                    sh 'vendor/bin/phpunit --debug'
                
            }
        }

       stage('Deploy to EC2') {
    steps {
        sh 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@10.0.2.115 "rm -rf /var/www/deploy/*"'
        sh 'scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -r target/* ubuntu@10.0.2.115:/tmp/'
        sh 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@10.0.2.115 "mkdir -p /var/www/deploy && cp -r /tmp/* /var/www/deploy/"'
    }
}


    }
}
